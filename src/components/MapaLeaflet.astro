---
interface Props {
  center: [number, number];
  zoom: number;
  playas: any[];
  containerId?: string;
}

const { center, zoom, playas, containerId = "map" } = Astro.props;
---

<div id={containerId} class="w-full h-[50vh] md:h-[600px] z-0 rounded-xl shadow-lg border-4 border-white relative overflow-hidden" style="min-height: 400px; max-height: 600px;"></div>

<script define:vars={{ center, zoom, playas, containerId }}>
  // Function to initialize map
  function initMap() {
    // Check if L (Leaflet) is loaded
    if (typeof L === 'undefined') {
      // Retry after a short delay if Leaflet isn't loaded yet
      setTimeout(initMap, 100);
      return;
    }

    const mapElement = document.getElementById(containerId);
    if (!mapElement) return;

    // Prevent re-initialization if map already exists on this element
    // @ts-ignore
    if (mapElement._leaflet_id) return;

    const map = L.map(containerId, {
      preferCanvas: false
    }).setView(center, zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Force map to recalculate size after initialization
    setTimeout(() => {
      map.invalidateSize();
    }, 100);

    // Custom Icons
    const beachIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const visitedIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    playas.forEach(playa => {
        const data = playa.data;
        if (data.lat && data.lng) {
             const icon = data.visitada ? visitedIcon : beachIcon;
             const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
             
             const popupContent = `
                <div class="text-center min-w-[200px]">
                    <h3 class="font-display text-xl mb-1 text-ocean-deep">${data.title}</h3>
                    ${data.description ? `<p class="font-body text-sm mb-2 text-gray-600">${data.description}</p>` : ''}
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs font-bold ${data.visitada ? 'text-green-600' : 'text-orange-500'}">
                            ${data.visitada ? '✅ Visitada' : '⏳ Pendiente'}
                        </span>
                        ${data.link ? `<a href="${data.link}" target="_blank" class="text-sunset-coral font-bold text-sm hover:underline">Ver más &rarr;</a>` : ''}
                    </div>
                </div>
             `;
             
             marker.bindPopup(popupContent);
        }
    });
  }

  // Run on load with a small delay to ensure DOM is ready
  function startInit() {
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      // Use requestAnimationFrame to ensure layout is complete
      requestAnimationFrame(() => {
        setTimeout(initMap, 50);
      });
    } else {
      document.addEventListener('DOMContentLoaded', () => {
        requestAnimationFrame(() => {
          setTimeout(initMap, 50);
        });
      });
    }
  }
  
  startInit();
  
  // Support Astro View Transitions
  document.addEventListener('astro:page-load', () => {
    const mapEl = document.getElementById(containerId);
    if (mapEl && !mapEl._leaflet_id) {
      requestAnimationFrame(() => {
        setTimeout(initMap, 50);
      });
    }
  });
</script>


